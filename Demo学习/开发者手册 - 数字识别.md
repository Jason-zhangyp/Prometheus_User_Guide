# 数字识别
  
本教程的目的：
 - 理解数字识别程序背后的原理
 - 读懂数字识别程序，并能够进行二次开发
 - 学会使用数字识别程序的接口，完成与数字识别相关的飞行任务


## 准备工作

- 安装python2运行时环境，pytorch和opencv-python
	
    `pip install torch==1.4.0+cpu torchvision==0.5.0+cpu -f https://download.pytorch.org/whl/torch_stable.html`
	
    `pip install opencv-python=='3.4.2.16'`
- 如果出现以下报错：No module named 'skbuild'，执行：

	`pip install scikit-build`
- 如果出现以下报错：ft2build.h: No such file or directory，执行：
	
    `sudo apt-get install libfreetype6-dev`
	
    `sudo apt-get install libpng-dev`

## 功能介绍

** pytorch_mnist_camera.py及pytorch_mnist_gazebo.py** 
 - 真实环境中的检测对应的程序为`pytorch_mnist_camera.py`，订阅的相机话题为`/prometheus/camera/rgb/image_raw`
 - 仿真环境中的检测对应的程序为`pytorch_mnist_gazebo.py`，订阅的相机话题为`/P300_Monocular_front/Monocular/image_raw`

- 数字识别网络——LeNet-5，结构如下图所示

[![GwfGjA.png](https://s1.ax1x.com/2020/04/04/GwfGjA.png)](https://imgchr.com/i/GwfGjA)

- 透视n点算法估计相对位姿

[![Gw4wlQ.png](https://s1.ax1x.com/2020/04/04/Gw4wlQ.png)](https://imgchr.com/i/Gw4wlQ)

** number_detection.cpp** 

 - 订阅来自图像的识别信息，这里使用了自定义的消息`prometheus_msgs::MultiDetectionInfo`，具体消息格式可以在`msgs`文件夹中查看
 
 		`ros::Subscriber vision_sub = nh.subscribe<prometheus_msgs::MultiDetectionInfo>("/prometheus/target", 10, vision_cb);`
        
 - 控制飞机自主起飞并悬停在数字墙前方，并打印显示识别结果。（注意：此处显示的结果为相机坐标系数值）
[![GwZKit.md.png](https://s1.ax1x.com/2020/04/04/GwZKit.md.png)](https://imgchr.com/i/GwZKit)



## 数字识别Gazebo仿真世界说明
  
  具体world配置内容，请查看`wall_num.world`及`wall_with_num.sdf`
  
  当飞机悬停于[0,0,1.5]位置，并正对数字墙时，每一个数字ID相对于飞机的距离为
   - 数字0：前方5米，左边2米，上方1米
   - 数字1：前方5米，左边1米，上方1米
   - 数字2：前方5米，左边0米，上方1米
   - 数字3：前方5米，右边1米，上方1米
   - 数字4：前方5米，右边2米，上方1米
   - 数字5：前方5米，左边2米，下方1米
   - 数字6：前方5米，左边1米，下方1米
   - 数字7：前方5米，左边0米，下方1米
   - 数字8：前方5米，右边1米，下方1米
   - 数字9：前方5米，右边2米，下方1米

注意：由于相机坐标系与机体坐标系不重合，以及数字ID和墙体厚度的原因，解算出来的相对位置并不精准。

  [![GwVEEn.md.png](https://s1.ax1x.com/2020/04/04/GwVEEn.md.png)](https://imgchr.com/i/GwVEEn)

## 如何进行数字识别的Gazebo仿真？  
  
 - 运行launch文件
	 `roslaunch prometheus_gazebo sitl_number_detection.launch`
 - 在`number_detection`终端中输入1开始任务，飞机将自动解锁，切换至OFFBOARD模式，并起飞至悬停点[0,0,1.5]
[![GwVFBj.md.png](https://s1.ax1x.com/2020/04/04/GwVFBj.md.png)](https://imgchr.com/i/GwVFBj)
 - 可在窗口中观察到数字的识别情况，也可以在终端中查看识别情况及相对距离。
[![GwVkHs.md.png](https://s1.ax1x.com/2020/04/04/GwVkHs.md.png)](https://imgchr.com/i/GwVkHs)

## 如何进行真机实验？  

待补充  
  

